<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/paper-slider/paper-slider.html">

<link rel="import" href="../bower_components/ami-import/ami-import.html">

<link rel="import" href="ami-3d/ami-3d.html">

<link rel="import" href="module-manager/module-manager.html">
<link rel="import" href="module-fileBrowser/module-fileBrowser.html">
<link rel="import" href="module-scene/module-scene.html">
<link rel="import" href="module-editor/module-editor.html">

<dom-module id="my-app">
  <template>
    <style>
      :host {
        --app-primary-color: #424242;
        --app-light-primary-color: #eeeeee;

        --app-secondary-color: #212121;

        --app-third-color: #757575;

        --app-accent-color: #03a9f4;
        --app-dark-accent-color: #01579b;

        --paper-tab-ink: var(--app-accent-color);
        --paper-tabs-selection-bar-color: var(--app-accent-color);

        --paper-slider-knob-color: var(--app-accent-color);
        --paper-slider-pin-color: var(--app-accent-color);
        /*--paper-slider-container-color: var(--app-dark-accent-color);*/
        --paper-slider-active-color: var(--app-accent-color);

        --paper-fab-background: var(--app-accent-color);
        --paper-fab-keyboard-focus-background: var(--app-dark-accent-color);

        --paper-input-container-focus-color: var(--app-dark-accent-color);

        display: flex;
        flex-direction: column;

        background-color: #eeeeee;

        position: absolute;
        top:0;
        left:0;
        right:0;
        bottom:0;

      }

      paper-range-slider {
        --paper-range-slider-knob-color: var(--app-accent-color);
        --paper-range-slider-active-color: var(--app-accent-color);
        --paper-range-slider-pin-color: var(--app-accent-color);
      }

      .paper-range-slider {
        display: flex;
      }

      .paper-range-slider paper-input{
        width: 50px;
        overflow: hidden;
      }

      app-toolbar {
        color: #fff;
        background-color: var(--app-primary-color);
      }

      .content {
        flex: 1;

        display: flex;
        flex-direction: row;
      }

      .controls {
        min-width: 400px;
        max-width: 400px;
        height:100%;

        display: flex;
        flex-direction: column;

        background-color: var(--app--light-primary-color);
      }

      .renderers {
        width: 100%;
        display: flex;
        flex-wrap: wrap;

        background-color: #353535;
      }

      .renderers > div {
        box-sizing:border-box;
        border: 1px solid rgba(0, 0, 0, .2);
        position: relative;
        overflow: hidden;
      }

      div.v1 {
        border-top: 1px solid #ffeb3b;
      }

      .big {
        height: 70%;
        width:100%;
      }

      div.v2 {
        border-top: 1px solid #f44336;
      }

      div.v3 {
        border-top: 1px solid #4caf50;
      }

      div.v4 {
        border-top: 1px solid #2196f3;
      }

      .small {
        height: 30%;
        flex: 1;
        position: relative;
      }

      paper-slider {
        width: 100%;
        position: absolute;
        bottom: 0px;
      }



    </style>

    <app-toolbar>
      <div main-title>AMI Visualizer</div>
    </app-toolbar>

    <div class="content">

      <module-manager id="manager" class="controls">
        <module-fileBrowser id="module-fileBrowser" class="module" label="data" files=[[files]] on-load-data="_loadData"></module-fileBrowser>
        <module-scene id="module-scene" class="module" label="scene" scene="[[scene]]"></module-scene>
        <module-editor id="module-editor" class="module" label="editor"></module-editor>
      </module-manager>

      <div class="renderers">
        <ami-3d id='r3d' class="v1 big"></ami-3d>
        <div class="v2 small">
          <paper-slider value="21" pin></paper-slider>
        </div>
        <div class="v3 small">
          <paper-slider value="21" pin></paper-slider>
        </div>
        <div class="v4 small">
          <paper-slider value="21" pin></paper-slider>
        </div>
      </div>

    </div>

  </template>

  <script>
    Polymer({
      is: 'my-app',
      properties :{
        files: {
          type: Array,
          value: [
            {data:{
              fname: 'Ixcvxcvxcv',
            }},
            {data:{
              fname: 'Ixcvxcvxcv/AM',
            }},
            {data:{
              fname: 'yes',
            }},
            {data:{
              fname: 'a/cool/file',
            }},
            {data:{
              fname: 'me/too',
            }}
          ]
        },
        sceneMap: {
          type: Object,
          value: new Map(),
          // observer: '_sceneChanged',
        },
        scene: {
          type: Array,
          value: [],
          observer: '_sceneChanged',
        }
      },

      observers: [
        '_sceneChanged(scene.*)'
      ],

      _loadData: function(event) {
        var data = event.detail.data;
        // load if not alread in scene!
        if(!this.sceneMap.has(data.id)){
          this.sceneMap.set(data.id, data);
          // this.scene[data.id] = data;
          // this.set(`scene.${data.id}`, data);
          // ami.load.then();
        }

        this.$.manager.selected = 1;
        // this.$.manager.loading = true;

        this.push('scene', {
          id: 0,
          type: 'volume',
          style: {
            minMax: [0, 100],
            windowLevel: [20, 80],
            threshold: [5, 95],
            lut: 'BW',
          },
          info: {
            size: [10,20],
            images: 50,
            seriesNumber: 5,
            thickness: 1,
            patientID: 'I\'m patient id',
            patientBirthdate: '20142424',
            patientAge: '234',
            studyDescription: 'I am the stud desc',
            seriesDescription: 'series desc',
            stationName: 'MRE453',
            modality: 'MR',
            sequenceName: 'seq name',
            studyDate: 'stud date',
            seriesDate: 'series date',
            acquisitionDate: 'acq date',
            acquisitionTime: 'acq time',
          },
          amiObj: null
        });
        var index = this.scene.length - 1;

        // fun 
        var LoadersVolume = AMI.default.Loaders.Volume;
        var loader = new LoadersVolume();

        var t2 = [
          '36444280', '36444294', '36444308', '36444322', '36444336',
          '36444350', '36444364', '36444378', '36444392', '36444406',
          '36748256', '36444434', '36444448', '36444462', '36444476',
          '36444490', '36444504', '36444518', '36444532', '36746856',
          '36746870', '36746884', '36746898', '36746912', '36746926',
          '36746940', '36746954', '36746968', '36746982', '36746996',
          '36747010', '36747024', '36748200', '36748214', '36748228',
          '36748270', '36748284', '36748298', '36748312', '36748326',
          '36748340', '36748354', '36748368', '36748382', '36748396',
          '36748410', '36748424', '36748438', '36748452', '36748466',
          '36748480', '36748494', '36748508', '36748522', '36748242'
        ];

        var files = t2.map(function(v) {
          return 'https://cdn.rawgit.com/FNNDSC/data/master/dicom/adi_brain/' + v;
        });

        // load sequence for all files
        loader.load(files)
        .then(function() {
          var series = loader.data[0].mergeSeries(loader.data);
          var stack = series[0].stack[0];
          stack.prepare();
          this.set(['scene', index, 'amiObj'], stack);
          this.$.manager.loading = false;
          // attach it to scene element.
          this.$['module-scene'].selected = this.scene[index];

          var HelpersStack = AMI.default.Helpers.Stack;
          var stackHelper = new HelpersStack(stack);
          stackHelper.bbox.color = 0x8BC34A;
          stackHelper.border.color = 0xF44336;
          this.$.r3d.add(stackHelper);
        }.bind(this));

      },

      _sceneChanged: function(){

        console.log(this.scene);

      },

      clickInput: function(evt) {
        this.$.filesinput.click();
      },

      localFS_load: function(evt) {
        // convert files object to an array
        var files = [];
        for ( var i = 0; i < evt.target.files.length; i++ ) {
          files.push( evt.target.files[i] );
        }
        this.files =  files;
        console.log(this.files);
        // process files then add it to scene if makes sense.
      }
    });
  </script>
</dom-module>
