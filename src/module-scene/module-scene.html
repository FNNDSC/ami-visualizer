<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-range-slider/paper-range-slider.html">

<dom-module id="module-scene">
    <template>
        <style>
        :host{
            flex:1;
            display:flex;
            flex-direction: column;
        }

        paper-range-slider {
            --paper-range-slider-knob-color: var(--app-accent-color);
            --paper-range-slider-active-color: var(--app-accent-color);
            --paper-range-slider-pin-color: var(--app-accent-color);
        }

        .paper-range-slider {
            display: flex;
        }

        .paper-range-slider paper-input{
            width: 50px;
            overflow: hidden;
        }

        .controls-scene-select {
            position: relative;
            padding: 10px;
            flex: 1;
            min-height: 100px;
            max-height: 300px;
            display:flex;
        }

        .controls-scene-select-list {
            flex:1;

            border: 1px solid #424242;
            background-color: #fff;

            overflow: auto;
        }
        
        paper-fab {
            bottom: 20px;
            right: 20px;
            position: absolute;
        }

        #filesinput {
            display: none;
        }

        .controls-scene-properties {
            flex:1;
        }

        .controls-scene-properties-pages {
            margin: 10px;
        }

        paper-dropdown-menu {
            width: 100%;
        }

        paper-item, paper-icon-item {
            --paper-item: {
                cursor: pointer;
            };
            --paper-item-selected: {
                background-color: var(--app-light-accent-color);
            }
        }

        .avatar {
            display: inline-block;
            box-sizing: border-box;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--paper-amber-500);
        }

        .grey {
            background-color: #d9d9d9;
        }
        
        paper-progress {
            width: inherit;
        }
        </style>

        <div class="controls-scene-select">
            <div class="controls-scene-select-list">

                <paper-listbox selected="{{selectedIndex}}">
                <template is="dom-repeat" items="[[scene]]">
                            <paper-icon-item class="menu-trigger"  on-tap="_view">
            <paper-icon-button item-icon icon$="{{_computeIcon(item)}}" alt="favourite this!" class="avatar grey">
            </paper-icon-button>
            <paper-item-body two-line>

    <template is="dom-if" if="{{item.amiObj}}">
            <div>[[item.info.studyDescription]]</div>
            <div secondary>[[item.info.seriesDescription]] ([[item.info.images]] images)</div>
    </template>


    <template is="dom-if" if="{{!item.amiObj}}">
            <div secondary>Loading data...</div>
            <paper-progress indeterminate class="blue"></paper-progress>
    </template>

            </paper-item-body>

        </paper-icon-item>

                </template>
                </paper-listbox>

            </div>

            <paper-fab mini icon="icons:add" title="add" on-tap="clickInput"></paper-fab>
            <input type="file" id="filesinput" on-change="localFS_load" multiple="">

        </div>

        <div class="controls-scene-properties">
            <div class="controls-scene-properties-controls">

            <paper-tabs selected="{{selectedProperty}}">
                <paper-tab>STYLE</paper-tab>
                <paper-tab>ABOUT</paper-tab>
                <paper-tab>MORE</paper-tab>
            </paper-tabs>

            <iron-pages class="controls-scene-properties-pages" selected="{{selectedProperty}}">
                
                <div class="controls-scene-properties-appearance">
                    <!--volume selected-->
                    <template is="dom-if" if="{{_volumeSelected(selected)}}">
                        <div>
                            <div>Window/Level</div>
                            <div class="paper-range-slider">
                            <paper-input value="{{props.wlmin}}"></paper-input><paper-range-slider min="{{wlmin}}" max="{{wlmax}}" value-min="{{props.wlmin}}" value-max="{{props.wlmax}}"  style="width:100%"></paper-range-slider><paper-input value="{{props.wlmax}}"></paper-input>
                            </div>
                        </div>
                        <div>
                            <div>Threshold</div>
                            <div class="paper-range-slider">
                            <paper-input value="{{props.thmin}}"></paper-input><paper-range-slider min="{{thmin}}" max="{{thmax}}" value-min="{{props.thmin}}" value-max="{{props.thmax}}"  style="width:100%"></paper-range-slider><paper-input value="{{props.thmax}}"></paper-input>
                            </div>
                        </div>
                        <div>
                            <div>LUT</div>
                            <div>
                            <paper-dropdown-menu label="Lookup table" vertical-align="bottom">
                                <paper-listbox class="dropdown-content" selected="0">
                                <paper-item>Black/White</paper-item>
                                <paper-item>Rainbow</paper-item>
                                <paper-item>Red</paper-item>
                                <paper-item>Heat</paper-item>
                                </paper-listbox>
                            </paper-dropdown-menu>
                            </div>
                        </div>
                    </template>
                
                </div>

                <div class="controls-scene-properties-info">
                <div>Image dimensions</div>
                <div>Orientation</div>
                <div>Nb of vertices</div>
                ...
                </div>

                <div>SETTINGS</div>
            </iron-pages>

            </div>
        </div>

    </template>
    <script>
        Polymer({
            is: 'module-scene',
            properties: {
                scene: {
                    type: Array,
                    value: [],
                },
                selectedProperty: {
                    type: String,
                    value: 0,
                },
                selected: {
                    type: Object,
                    observer: '_selectedChanged',
                },
                selectedIndex: {
                    type: Number,
                    observer: '_selectedIndexChanged',
                },
                // volume specific properties
                wlmin: {
                    type: Number,
                },
                wlmax: {
                    type: Number,
                },
                thmin: {
                    type: Number,
                },
                thmax: {
                    type: Number,
                },
                props: {
                    type: Object,
                    value: {
                        id: null,
                        wlmax: null,
                        wlmin: null,
                        thmin: null,
                        thmax: null,
                        // interpolation
                        // invert
                        // lut...
                    },
                }
            },
            observers: [
              // order matters
              '_initState(scene.*.amiObj)',
              '_sceneChanged(scene.*)',
              '_propertiesChanged(props.*)',
            ],
            _sceneChanged: function() {
                console.log(this.scene);
            },
            _computeIcon: function(item){
                console.log(item);
                return item.type === 'volume' ? 'icons:folder' : 'editor:insert-drive-file';
           },
           _view: function(event){
                this.set('selected', event.model.__data__.item);
           },
           _selectedIndexChanged: function(){
               this.set('selected', this.scene[this.selectedIndex])
           },
           _selectedChanged: function(){
               console.log(this.selected.amiObj.minMax);
               console.log(this.selected.amiObj.windowCenter);
               this.props.id = null;
               // set window Level
               this.wlmin = this.selected.amiObj.minMax[0];
               this.wlmax = this.selected.amiObj.minMax[1];
               this.set(['props','wlmin'], Math.round( this.selected.amiObj.windowCenter - this.selected.amiObj.windowWidth / 2));
               this.set(['props','wlmax'], Math.round( this.selected.amiObj.windowCenter + this.selected.amiObj.windowWidth / 2));

               // set threshold
               this.thmin = this.selected.amiObj.minMax[0];
               this.thmax = this.selected.amiObj.minMax[1];
               this.props.thmin = this.thmin;
               this.props.thmax = this.thmax;

               this.props.id = this.selected.id;
           },
           _volumeSelected: function(selected){
               if(!selected) return false;

               return selected.type === 'volume';
           },
           _propertiesChanged: function(){
                console.log('_propertiesChanged');
                if(this.props.id === null) return;

                var  event = new CustomEvent(('properties-changed'), {
                    detail: {
                        properties: this.props,
                        }
                });

                this.dispatchEvent(event);
            },
            _initState: function(value){
                console.log(value);
                // init object state
                console.log('init state');
                console.log(this.selected);
            }
        });
    </script>

</dom-module>